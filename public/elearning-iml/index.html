<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-Learning IML (Embedded)</title>
  <!-- NOTE: This is an embedded copy adapted for SSO portal. Keep heavy logic but add handshake + theme sync -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Minimal shell; original styles retained via styles.css */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .sso-banner { position:fixed;top:0;left:0;right:0;z-index:9999;font-size:11px;padding:4px 8px;display:flex;gap:8px;align-items:center;justify-content:space-between;background:rgba(15,23,42,.85);color:#e2e8f0;backdrop-filter:blur(6px); }
    .sso-badge { background:#334155;border:1px solid #475569;padding:2px 6px;border-radius:4px; }
    .sso-badge.admin { background:#92400e;border-color:#f59e0b;color:#fcd34d; }
    html.dark body { background:#0f172a; color:#e2e8f0; }
    body.wide-edge main.container { max-width:100%; width:100%; padding-left:clamp(12px,1.2vw,32px); padding-right:clamp(12px,1.2vw,32px); }
  </style>
</head>
<body>
  <div id="sso-top" class="sso-banner" style="display:none">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <span class="sso-badge" id="sso-status">SSO CONNECTING...</span>
      <span class="sso-badge" id="sso-user">-</span>
      <span class="sso-badge" id="sso-role">role:-</span>
      <span class="sso-badge" id="sso-exp">exp:-</span>
      <span class="sso-badge" id="sso-jti" style="max-width:120px;overflow:hidden;text-overflow:ellipsis;">jti:-</span>
    </div>
    <button id="sso-logout" class="btn btn-sm btn-outline-warning py-0" style="line-height:1">Logout</button>
  </div>
  
  <!-- Embedded E-Learning Content -->
  <main class="container py-5">
    <div class="row">
      <div class="col-md-3">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-graduation-cap"></i> Menu E-Learning</h6>
          </div>
          <div class="list-group list-group-flush">
            <button class="list-group-item list-group-item-action" onclick="showSection('modul')">
              <i class="fas fa-book"></i> Modul Ajar
            </button>
            <button class="list-group-item list-group-item-action" onclick="showSection('materi')">
              <i class="fas fa-file-text"></i> Materi Pembelajaran
            </button>
            <button class="list-group-item list-group-item-action" onclick="showSection('pre-test')">
              <i class="fas fa-edit"></i> Pre-Test
            </button>
            <button class="list-group-item list-group-item-action" onclick="showSection('post-test')">
              <i class="fas fa-check-circle"></i> Post-Test
            </button>
          </div>
        </div>
      </div>
      
      <div class="col-md-9">
        <div id="content-area">
          <!-- Default content -->
          <div id="welcome-section" class="content-section">
            <div class="card">
              <div class="card-body">
                <h4><i class="fas fa-bolt text-primary"></i> E-Learning Instalasi Motor Listrik</h4>
                <p class="text-muted mb-3">Platform pembelajaran untuk mata pelajaran Instalasi Motor Listrik (IML)</p>
                
                <div class="row">
                  <div class="col-md-6">
                    <div class="card border-primary mb-3">
                      <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-target"></i> Tujuan Pembelajaran</h6>
                        <ul class="small mb-0">
                          <li>Memahami prinsip kerja motor listrik</li>
                          <li>Menguasai instalasi forward-reverse</li>
                          <li>Menerapkan K3 dalam praktik</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card border-success mb-3">
                      <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-cogs"></i> Kompetensi</h6>
                        <p class="small mb-0">Teknik Instalasi Tenaga Listrik (TITL) - Kelas XI</p>
                        <p class="small text-muted mb-0">Alokasi: 6 x 45 menit</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i> 
                  <strong>Petunjuk:</strong> Pilih menu di sidebar kiri untuk memulai pembelajaran. 
                  Disarankan mengikuti urutan: Modul → Materi → Pre-Test → Post-Test.
                </div>
              </div>
            </div>
          </div>
          
          <!-- Content sections will be loaded here -->
        </div>
      </div>
    </div>
  </main>

  <script>
  (function(){
    const ALLOWED_ORIGINS = [window.location.origin, 'http://localhost:5500'];
    const topBar = document.getElementById('sso-top');
    const st = id=> document.getElementById(id);
    const elStatus = st('sso-status');
    const elUser = st('sso-user');
    const elRole = st('sso-role');
    const elExp = st('sso-exp');
    const elJti = st('sso-jti');
    const btnLogout = st('sso-logout');
    let currentPayload = null;

    function parseJWT(t){
      try { const p=t.split('.'); if(p.length!==3) return null; return JSON.parse(atob(p[1].replace(/-/g,'+').replace(/_/g,'/'))); } catch { return null; }
    }

    function tsLeft(payload){ if(!payload||!payload.exp) return '-'; const ms = payload.exp*1000 - Date.now(); if(ms<=0) return 'exp'; return Math.floor(ms/1000)+'s'; }

    function updateBar(){
      if(!currentPayload){ elStatus.textContent='NO TOKEN'; return; }
      elStatus.textContent='SSO OK';
      elUser.textContent = currentPayload.email || '-';
      elRole.textContent = 'role:'+(currentPayload.role||'-');
      elExp.textContent = 'ttl:'+tsLeft(currentPayload);
      elJti.textContent = 'jti:'+(currentPayload.jti?currentPayload.jti.slice(0,12)+'…':'-');
      topBar.style.display='flex';
      if(currentPayload.role==='admin') elRole.classList.add('admin','sso-badge','admin');
    }

    // Send ready signal
    try { window.parent && window.parent.postMessage({ type:'EMBED_READY', app:'elearning-iml' }, '*'); } catch {}

    // Listen for theme & token
    window.addEventListener('message', function(e){
      if(e.origin && !ALLOWED_ORIGINS.includes(e.origin)) return;
      const d = e.data || {};
      if(d.type === 'SSO_TOKEN'){
        const pl = parseJWT(d.token);
        if(!pl || !pl.email || (pl.exp*1000 < Date.now())) return;
        currentPayload = pl; updateBar();
      } else if(d.type === 'THEME_SYNC') {
        document.documentElement.classList.toggle('dark', !!d.dark);
      } else if(d.type === 'LAYOUT_MODE') {
        if(d.wide){ document.body.classList.add('wide-edge'); }
        else { document.body.classList.remove('wide-edge'); }
      }
    });

    btnLogout.addEventListener('click', ()=>{
      try { window.parent && window.parent.postMessage({ type:'SSO_LOGOUT', app:'elearning-iml' }, '*'); } catch {}
    });

    // Fallback: show bar after 3s even if no token (for debugging)
    setTimeout(()=>{ if(!currentPayload) { topBar.style.display='flex'; elStatus.textContent='WAITING TOKEN'; } },3000);

    // Navigation function for content sections
    window.showSection = function(section) {
      const contentArea = document.getElementById('content-area');
      
      // Remove active state from all menu items
      document.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Add active state to clicked item
      event.target.classList.add('active');
      
      // Load content based on section
      switch(section) {
        case 'modul':
          loadContent('modul-ajar.html', 'Modul Ajar');
          break;
        case 'materi':
          loadContent('materi-pembelajaran.html', 'Materi Pembelajaran');
          break;
        case 'pre-test':
          loadContent('pre-test.html', 'Pre-Test');
          break;
        case 'post-test':
          loadContent('post-test.html', 'Post-Test');
          break;
        default:
          contentArea.innerHTML = document.getElementById('welcome-section').outerHTML;
      }
    };

    function loadContent(url, title) {
      const contentArea = document.getElementById('content-area');
      contentArea.innerHTML = `
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-spinner fa-spin"></i> Memuat ${title}...</h5>
          </div>
          <div class="card-body">
            <iframe src="${url}" 
                    class="w-100" 
                    style="height: 600px; border: none; border-radius: 8px;"
                    onload="this.previousElementSibling.querySelector('h5').innerHTML='<i class=\\"fas fa-check-circle text-success\\"></i> ${title}'">
            </iframe>
          </div>
        </div>
      `;
    }
  })();
  </script>
</body>
</html>